
<!DOCTYPE html>
<html lang="en">
<head>
	<!-- 지도 화면 채우기-->
	<style>
		* { margin : 0}
	</style>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>Apart price analysis</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.11.2/css/all.css" />
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
    <!-- MDB -->
  	<link rel="stylesheet" href="../static/css/mdb.min.css" />
    <!-- Custom styles -->
    <link rel="stylesheet" href="../static/css/style.css" />
    <script src="http://code.jquery.com/jquery-latest.min.js"></script>
    
</head>
<body>
    <!--Main Navigation-->
<header>
  <!-- Sidebar -->
  <nav id="sidebarMenu"class="collapse d-lg-block sidebar collapse bg-white" style = width:400px>
    <div class="position-sticky">
      <div class="list-group list-group-flush mx-3 mt-4" >
	      <!-- Search form -->
	      <div class="d-none d-md-flex input-group w-auto my-auto">
	        <input
	               autocomplete="off"
	               type="search"
	               class="form-control rounded"
	               placeholder='아파트 검색'
	               style="min-width: 225px"
	               id = "search"
	               />
	        
	        <span class="input-group-text border-0" >
	        	<button id="serch" class="fas fa-search" onclick="data()" type = "submit"></button>
	        </span>
	        <div class="d-none d-md-flex input-group" id="apartList"></div>     
	      </div>
       	  <!-- Pagination -->
            <div class="pagination">
                <div id='prev'></div>
                <div id='next'></div>
      		</div>
    	</div>
    </div>
  </nav>
  <!-- Sidebar -->

  <!-- Navbar -->
  <nav
       id="main-navbar"
       class="navbar navbar-expand-lg navbar-light bg-white fixed-top"
       >
    <!-- Container wrapper -->
    <div class="container-fluid">
      <!-- Toggle button -->
      <button
              class="navbar-toggler"
              type="button"
              data-mdb-toggle="collapse"
              data-mdb-target="#sidebarMenu"
              aria-controls="sidebarMenu"
              aria-expanded="false"
              aria-label="Toggle navigation"
              >
        <i class="fas fa-bars"></i>
      </button>

      <!-- Brand -->
      <a class="navbar-brand" href="#">
        <img
             src="https://mdbootstrap.com/img/logo/mdb-transaprent-noshadows.png"
             height="25"
             alt=""
             loading="lazy"
             />
      </a>
      

      <!-- Right links -->
      <ul class="navbar-nav ms-auto d-flex flex-row">
        <!-- Notification dropdown -->
        <li class="nav-item dropdown">
          <a
             class="nav-link me-3 me-lg-0 dropdown-toggle hidden-arrow"
             href="#"
             id="navbarDropdownMenuLink"
             role="button"
             data-mdb-toggle="dropdown"
             aria-expanded="false"
             >
            <i class="fas fa-bell"></i>
            <span class="badge rounded-pill badge-notification bg-danger"
                  >1</span
              >
          </a>
          <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="navbarDropdownMenuLink"
              >
            <li><a class="dropdown-item" href="#">Some news</a></li>
            <li><a class="dropdown-item" href="#">Another news</a></li>
            <li>
              <a class="dropdown-item" href="#">Something else here</a>
            </li>
          </ul>
        </li>

        <!-- Icon -->
        <li class="nav-item">
          <a class="nav-link me-3 me-lg-0" href="#">
            <i class="fas fa-fill-drip"></i>
          </a>
        </li>
        <!-- Icon -->
        <li class="nav-item me-3 me-lg-0">
          <a class="nav-link" href="#">
            <i class="fab fa-github"></i>
          </a>
        </li>

        <!-- Avatar -->
        <li class="nav-item dropdown">
          <a
             class="nav-link dropdown-toggle hidden-arrow d-flex align-items-center"
             href="#"
             id="navbarDropdownMenuLink"
             role="button"
             data-mdb-toggle="dropdown"
             aria-expanded="false"
             >
            <img
                 src="https://mdbootstrap.com/img/Photos/Avatars/img (31).jpg"
                 class="rounded-circle"
                 height="22"
                 alt=""
                 loading="lazy"
                 />
          </a>
          <ul
              class="dropdown-menu dropdown-menu-end"
              aria-labelledby="navbarDropdownMenuLink"
              >
            <li><a class="dropdown-item" href="#">My profile</a></li>
            <li><a class="dropdown-item" href="#">Settings</a></li>
            <li><a class="dropdown-item" href="#">Logout</a></li>
          </ul>
        </li>
      </ul>
    </div>
    <!-- Container wrapper -->
  </nav>
  <!-- Navbar -->
</header>
<!--Main Navigation-->

<!--Main layout-->
<main style="margin-top: 72px;padding-left: 389px;">
  <div class="container-fluid" style='margin-left: 0px;'>
        <p style="margin-top:-12px">
		    <em class="link">
		        <!--<a href="javascript:void(0);" onclick="window.open('http://fiy.daum.net/fiy/map/CsGeneral.daum', '_blank', 'width=981, height=650')">
		            혹시 주소 결과가 잘못 나오는 경우에는 여기에 제보해주세요.
		        </a>-->
		    </em>
		</p>
		<div id="map" style="width:100vw;height:100vh;"></div>
    
  </div>
</main>
<!--Main layout-->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3209863b8ce059f0b5c2bf4e41cfef2d&libraries=services"></script>
<script>
	//마커와 윈도우를 담을 배열입니다
	var markers = [];
	var windows = [];
	
	var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
	mapOption = {
	    center: new kakao.maps.LatLng(37.551425, 126.988), // 지도의 중심좌표
	    level: 7 // 지도의 확대 레벨
	}; 
	// 주소-좌표 변환 객체를 생성합니다
	var geocoder = new kakao.maps.services.Geocoder();
	
	// 지도를 생성합니다    
	var map = new kakao.maps.Map(mapContainer, mapOption); 
	
	let clickApt = null;
	function jusoSearch(){
		//클릭한 요소 가져오기
		let dv = event.currentTarget;
		clickApt = dv.innerText;
		//아파트 이름으로 주소 받아오기
		map1(ajaxResult.aptJusoJson[clickApt]);
	} 
		
	function map1(juso){

		// 주소로 좌표를 검색합니다
		geocoder.addressSearch(juso, function(result, status) {
		
		    // 정상적으로 검색이 완료됐으면 
		     if (status === kakao.maps.services.Status.OK) {
		
		        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
		        
		        // 마커랑 윈도우 초기화
		        removeMarker();
	            removeWindow();
	            
	            // index는 1개만 필요해서 0
				i=0;
		        // 결과값으로 받은 위치를 마커로 표시합니다
 				var marker = addMarker(coords, i);
				
		        // 마커에 mouseover 이벤트를 등록합니다
		        kakao.maps.event.addListener(marker, 'click', function() {
					location.href = "graph?aptName="+juso;
	
		        });
		        
		        // 인포윈도우로 장소에 대한 설명을 표시합니다
              	var infowindow = addWindow(map, marker, i)

		        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
		        map.setCenter(coords);
		    } 
		});
	}
	
	// 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
	   function addMarker(position, idx, title) {
	       var imageSrc = 'https://i1.daumcdn.net/dmaps/apis/n_local_blit_04.png', // 마커 이미지 url, 스프라이트 이미지를 씁니다
	           imageSize = new kakao.maps.Size(31, 35),  // 마커 이미지의 크기
	           imgOptions =  {
	           },
	           markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imgOptions),
	               marker = new kakao.maps.Marker({
	               position: position, // 마커의 위치
	               image: markerImage 
	           });

	       marker.setMap(map); // 지도 위에 마커를 표출합니다
	       markers.push(marker);  // 배열에 생성된 마커를 추가합니다

	       return marker;
	   }
	// 윈도우를 생성하고 지도 위에 마커를 표시하는 함수입니다
	   function addWindow(map, marker, idx){
	       var infowindow = new kakao.maps.InfoWindow({
	           content: '<div style="width:150px;text-align:center;padding:6px 0;">'+clickApt+'</div>'
	       });
	       infowindow.open(map, marker);
	       windows.push(infowindow)
	   }
	   
	// 지도 위에 표시되고 있는 마커를 모두 제거합니다
	   function removeMarker() {
	       for ( var i = 0; i < markers.length; i++ ) {
	           markers[i].setMap(null);
	       }   
	       markers = [];
	   }
	// 지도 위에 표시되고 있는 윈도우를 모두 제거합니다
	   function removeWindow() {
	       for ( var i = 0; i < windows.length; i++ ) {
	           windows[i].close();
	       }   
	       windows = [];
	   }
	
	// 페이징처리 변수 선언
	let send_data = {};
	// 다음페이지
	let nextPage = function(nextNum){
			  let page = nextNum;
			  send_data['page'] = page;
			  data()
	}
	
	//이전페이지
	let prevPage = function(prevNum){
		  let page = prevNum;
		  send_data['page'] = page;
		  data()
	}
	function data(){
		//검색어 담아 ajax로 보내기
		let search = document.getElementById("search").value;
		send_data['search'] = search;
		// prev next 버튼초기화
		$("#prev").empty();
		$("#next").empty();
		//페이징처리 함수
		  let pagination = function(data){
			  if (data.apt_lists['isPrev'] == true) {
				  	let $a = $('<a class="abutton" href=#" onClick = "prevPage('+ data.apt_lists['prevNum']+');">이전</a>')
	              	let a = document.createElement('a');
					$('#prev').append($a);
					$a.appendTo($('#prev'));
					document.getElementById('prev').appendChild(a);
				  } 
			  if(data.apt_lists['isNext'] == true){
					let $a = $('<a class="abutton" href=#" onClick= "nextPage('+data.apt_lists['nextNum']+');">다음</a>\
		                   ')
	              	let a = document.createElement('a');
					$('#next').append($a);
					$a.appendTo($('#next'));
					document.getElementById('next').appendChild(a);
				  }			
		  }
		//아파트리스트 불러오는 함수
		  let aptList = function(data){
			  console.log(data.apt_lists)
			  data.apt_lists['apt_list'].forEach(function(item, index){
				  let $a = $('<a href="#" onClick= "jusoSearch();"\
		                         class="aptlists list-group-item list-group-item-action py-2 ripple" \
		                         aria-current="true" > '
		                       +item+
		                      '</a>')
				  let a = document.createElement('a');
				  //let text = documemt.createTextNode('Test');
				  //div.appendChild(text);
				  $('#apartList').append($a);
				  $a.appendTo($('#apartList'));
				  document.getElementById('apartList').appendChild(a);
		        });
			  
		  }
			
		  //list 값 초기화
		  $("#apartList").empty();
	
		  $.ajax({
			  /* 비동기 통신 여부  */        
			 //async : false, 
		     url:"map/apart",
		     type:"get",
		     data:send_data,
		     dataType:"json",
		     success:function(data){
		    	 ajaxResult =data;
		    	 map1(ajaxResult.juso[0]);
		    	 aptList(data);
		    	 pagination(data);
		     },
		     error : function(){
		    	 alert('실패')
		     }
		  });
	}
		  	
</script>
<!-- MDB -->
<script type="text/javascript" src="../static/js/mdb.min.js"></script>
<!-- Custom scripts -->
<script type="text/javascript" src="../static/js/script.js"></script>
</body>
</html>